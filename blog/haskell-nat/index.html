<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="description" content="Prime Type Ltd, the company that will provide you with the cryptographic tools to enhance and secure your business.">
    <meta name="author" content="Nicolas Di Prima">
    <title>Prime Type</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.3/css/all.css"
        integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">

    <link href="https:&#x2F;&#x2F;primetype.co.uk&#x2F;/style.css" rel="stylesheet">

</head>




<body role="document" id="home">
    <nav class="navbar navbar-expand navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="https:&#x2F;&#x2F;primetype.co.uk">
                Prime Type
            </a>

            <div class="navbar-collapse">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="https:&#x2F;&#x2F;primetype.co.uk#home">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="https:&#x2F;&#x2F;primetype.co.uk&#x2F;blog">Blog</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    
<div class="p-5 mb-4 bg-danger text-white">
    <div class="container">
        <div class="row">
            <div class="col-md-2 text-center mh-100">
                <span class="h-resp-fa align-middle mh-100">
                    
                    <i class="fas fa-newspaper"></i>
                    
                </span>
            </div>
            <div class="col">
                <h1 class="h-title">Haskell&#x27;s Type Literal</h1>
                <p class="h-lead">A concrete problem solved with Type Literals</p>
                <p>
                    Wednesday 15 March 2017
                    
                </p>
            </div>
        </div>
    </div>
</div>
<div class="container py-5 page">
    <div class="row">
        <div class="col">
            <p>I came across a problem that needed to use Haskell's
<a href="//www.stackage.org/haddock/lts-8.5/base-4.9.1.0/GHC-TypeLits.html">Type Literals</a>.</p>
<p>Haskell's <em>Type Literals</em> enable a new world of possibility in APIs and help
solve day to day developer issues.</p>
<span id="continue-reading"></span>
<p>In a recent project, we needed to generate a <code>Blake2</code> hash of 8 bytes to fit in the
customer's protocol. Unfortunately, there was no straight forward way to
generate a Blake2 digest of 64 bits. The work around could be:</p>
<pre style="background-color:#2b303b;">
<code class="language-haskell" data-lang="haskell"><span style="color:#8fa1b3;">blakeb_160 </span><span style="color:#b48ead;">:: Data -&gt; Digest</span><span style="color:#c0c5ce;"> (</span><span style="color:#b48ead;">Blake2b_160</span><span style="color:#c0c5ce;">)

</span><span style="color:#8fa1b3;">hash64 </span><span style="color:#b48ead;">:: Data -&gt; Bytes
</span><span style="color:#c0c5ce;">hash64 = take </span><span style="color:#d08770;">8 </span><span style="color:#c0c5ce;">. toBytes . blakeb_160
</span></code></pre>
<p>This is will do, but it loses a lot of information. I would have to create my
own data type to wrap the digest of 8 bytes in order to give it the necessary
properties. <strong>But</strong> this is Haskell, we can do better.</p>
<h2 id="blake2">Blake2</h2>
<p>Blake2b is a cryptographic hash (with
<a href="//tools.ietf.org/html/rfc7693">interesting properties</a>). One of them is that
it can generate Digests from 8 bits long to 512bits long, providing it is
divisible by 8 ; i.e. digests of 1 byte to 64 bytes.</p>
<p>Cryptonite legacy APIs provide a <a href="https://www.stackage.org/haddock/lts-8.5/cryptonite-0.21/Crypto-Hash-Algorithms.html#t:Blake2b_512">set of known digests</a>
but ideally, we would like to enable every digest size possible, without
having to create 64 different type.</p>
<h2 id="tl-dr">TL;DR</h2>
<p>You can have a look at the
<a href="//github.com/haskell-crypto/cryptonite/pull/140">PR in cryptonite</a>.</p>
<h2 id="the-other-languages">The other languages</h2>
<h3 id="rust">Rust</h3>
<p>In <strong>Rust</strong> we would create a generic struct.</p>
<pre style="background-color:#2b303b;">
<code class="language-rust" data-lang="rust"><span style="color:#b48ead;">struct </span><span style="color:#c0c5ce;">Digest&lt;S: </span><span style="color:#b48ead;">usize</span><span style="color:#c0c5ce;">&gt;([</span><span style="color:#b48ead;">u8</span><span style="color:#c0c5ce;">;S]);

</span><span style="color:#b48ead;">impl </span><span style="color:#c0c5ce;">Digest&lt;S: </span><span style="color:#b48ead;">usize</span><span style="color:#c0c5ce;">&gt; {
  </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">generate</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">r</span><span style="color:#c0c5ce;">: &amp;</span><span style="color:#b48ead;">mut</span><span style="color:#c0c5ce;"> Reader) -&gt; Digest&lt;S&gt; {
    </span><span style="color:#65737e;">// ...
  </span><span style="color:#c0c5ce;">}
}
</span></code></pre>
<p>And to check the validity of the given <code>S</code>. We could use
<a href="http://paholg.com/typenum/typenum/index.html">typenum</a> to perform validity
check at compile time, at the type level.</p>
<h3 id="c">C++</h3>
<p>In <strong>C++</strong> we would use templates and some <code>static_assert</code>:</p>
<pre style="background-color:#2b303b;">
<code class="language-c++" data-lang="c++"><span style="color:#b48ead;">template</span><span style="color:#c0c5ce;">&lt;size_t S&gt;
</span><span style="color:#b48ead;">struct </span><span style="color:#c0c5ce;">Digest {
  </span><span style="color:#65737e;">// const expression evaluation is already builtin of C++
  </span><span style="color:#c0c5ce;">static_assert(</span><span style="color:#d08770;">8 </span><span style="color:#c0c5ce;">&lt;= S &amp;&amp; S &lt;= </span><span style="color:#d08770;">512</span><span style="color:#c0c5ce;">, &quot;</span><span style="color:#a3be8c;">invalid digest size</span><span style="color:#c0c5ce;">&quot;);
  std::array&lt;uint8_t, S / </span><span style="color:#d08770;">8</span><span style="color:#c0c5ce;">&gt; digest;
};
</span></code></pre><h2 id="haskell">Haskell</h2>
<p>Haskell comes with a brilliant idea, equivalent to the <strong>C++</strong> solution (to
a certain extent), the <strong>Type Literals</strong>.</p>
<pre style="background-color:#2b303b;">
<code class="language-haskell" data-lang="haskell"><span style="color:#65737e;">-- the type we are interested about today
</span><span style="color:#b48ead;">data </span><span style="color:#d08770;">Nat </span><span style="color:#c0c5ce;">:: *
</span><span style="color:#65737e;">-- a class to limit our type literal to
</span><span style="color:#b48ead;">class </span><span style="color:#a3be8c;">KnownNat </span><span style="color:#bf616a;">n
</span></code></pre>
<p>It allows you to write literals in your types and to
retrieve the value at runtime.</p>
<p>So in our case we could write:</p>
<pre style="background-color:#2b303b;">
<code class="language-haskell" data-lang="haskell"><span style="color:#65737e;">-- we can use the natural like we would use a type parameter.
</span><span style="color:#b48ead;">data </span><span style="color:#d08770;">Blake2b</span><span style="color:#c0c5ce;"> (n :: </span><span style="color:#d08770;">Nat</span><span style="color:#c0c5ce;">) = </span><span style="color:#d08770;">Blake2b

</span><span style="color:#65737e;">-- we can add conditions
</span><span style="color:#b48ead;">class</span><span style="color:#c0c5ce;"> (</span><span style="color:#a3be8c;">KnownNat </span><span style="color:#bf616a;">bitlen</span><span style="color:#c0c5ce;">, 8 &lt;= </span><span style="color:#bf616a;">bitlen</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">bitlen</span><span style="color:#c0c5ce;"> &lt;= 512) =&gt; </span><span style="color:#a3be8c;">Algorithm</span><span style="color:#c0c5ce;"> (</span><span style="color:#a3be8c;">Blake</span><span style="color:#c0c5ce;">2b </span><span style="color:#bf616a;">bitlen</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">where
    </span><span style="color:#65737e;">-- ...
</span></code></pre>
<p><strong>GHC</strong> will fail to compile any code making use of the <code>Blake2b 1024</code> (or any
other invalid value).</p>
<p>The only downside is that it is still missing a proper clean error message to
help developers. This is still possible. Since <code>ghc 8.0</code> we can define a
type error.</p>
<pre style="background-color:#2b303b;">
<code class="language-haskell" data-lang="haskell"><span style="color:#65737e;">-- we define a new type operator that will call a helper type family
</span><span style="color:#b48ead;">type </span><span style="color:#d08770;">IsAtMost</span><span style="color:#c0c5ce;"> (bitlen :: </span><span style="color:#d08770;">Nat</span><span style="color:#c0c5ce;">) (n :: </span><span style="color:#d08770;">Nat</span><span style="color:#c0c5ce;">) = </span><span style="color:#d08770;">IsLE</span><span style="color:#c0c5ce;"> bitlen n (bitlen &lt;=? n) ~ &#39;</span><span style="color:#d08770;">True

</span><span style="color:#b48ead;">type</span><span style="color:#c0c5ce;"> family </span><span style="color:#d08770;">IsLE</span><span style="color:#c0c5ce;"> (bitlen :: </span><span style="color:#d08770;">Nat</span><span style="color:#c0c5ce;">) (n :: </span><span style="color:#d08770;">Nat</span><span style="color:#c0c5ce;">) (c :: </span><span style="color:#d08770;">Bool</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">where
    </span><span style="color:#d08770;">IsLE</span><span style="color:#c0c5ce;"> bitlen n &#39;</span><span style="color:#d08770;">True  </span><span style="color:#c0c5ce;">= &#39;</span><span style="color:#d08770;">True
    IsLE</span><span style="color:#c0c5ce;"> bitlen n &#39;</span><span style="color:#d08770;">False </span><span style="color:#c0c5ce;">= </span><span style="color:#d08770;">TypeError
</span><span style="color:#c0c5ce;">      (     (&#39;</span><span style="color:#d08770;">Text </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">bitlen </span><span style="color:#c0c5ce;">&quot; &#39;:&lt;&gt;: &#39;</span><span style="color:#d08770;">ShowType</span><span style="color:#c0c5ce;"> bitlen &#39;:&lt;&gt;: &#39;</span><span style="color:#d08770;">Text </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;"> is greater than </span><span style="color:#c0c5ce;">&quot; &#39;:&lt;&gt;: &#39;</span><span style="color:#d08770;">ShowType</span><span style="color:#c0c5ce;"> n)
      &#39;:$$: (&#39;</span><span style="color:#d08770;">Text </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">You have tried to use an invalid Digest size. Please, refer to the documentation.</span><span style="color:#c0c5ce;">&quot;)
      )
</span></code></pre>
<p>Now, using an invalid literal would make <strong>GHC</strong> fail to compile with the
following error message:</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">~nicolas@primetype/haskell-crypto/cryptonite/tests/Hash.hs:202:23: error:
    • bitlen 1024 is greater than 512
      You have tried to use an invalid Digest size. Please, refer to the documentation.
    • In the expression: HashAlg (Blake2b :: Blake2b 1024)
      ...
</span></code></pre>
        </div>
    </div>

    <div class="row">
        <div class="col">
            <hr class="my-4">
        </div>
    </div>

    <div class="row">
        <div class="col-6 text-start">
            
            <a class="btn btn-outline-danger" href="https:&#x2F;&#x2F;primetype.co.uk&#x2F;blog&#x2F;yet-another-error-handling-2&#x2F;" data-toggle="tooltip"
                data-placement="bottom" title="C++: Yet Another Kind of error handling (Part 2)">
                <i class="fas fa-arrow-left"></i>
                C++: Yet Another Kin…
            </a>
            
        </div>
        <div class="col-6 text-end">
            

            <a class="btn btn-outline-danger" href="https:&#x2F;&#x2F;primetype.co.uk&#x2F;blog&#x2F;haskell-foundation-check&#x2F;" data-toggle="tooltip"
                data-placement="bottom" title="Foundation&#x27;s testing framework">
                Foundation&#x27;s testing…
                <i class="fas fa-arrow-right"></i>
            </a>
            
        </div>
    </div>
</div>


    <footer class="bg-dark text-center text-lg-start text-white">
        <!-- Grid container -->
        <div class="container p-4">
            <!--Grid row-->
            <div class="row mt-4">
                <!--Grid column-->
                <div class="col-md-6 mb-4 mb-md-0">
                    <h5 class="text-uppercase">Legals</h5>

                    <p>
                        <em>Prime Type Ltd</em> is a limited company registered in
                        <em>England and Wales</em>.<br>
                        <em>Registration number&nbsp;10597758</em>.<br>
                        <em>VAT registration number&nbsp;295196950.</em>
                    </p>
                </div>
                <!--Grid column-->

                <!--Grid column-->
                <div class="col-md-6 mb-4 mb-md-0">
                    <h5 class="text-uppercase">Write to us</h5>

                    <ul class="list-unstyled">
                        <li>
                            <a href="mailto:info@primetype.co.uk" class="text-white">
                                <i class="fas fa-at fa-fw fa-sm me-2"></i>
                                info@primetype.co.uk
                            </a>
                        </li>
                        <li>
                            <a href="https://github.com/primetype" target="_blank" class="text-white">
                                <i class="fab fa-github fa-fw fa-sm me-2"></i>
                                Check us out on github
                            </a>
                        </li>
                    </ul>
                </div>
                <!--Grid column-->
            </div>
            <!--Grid row-->
        </div>
        <!-- Grid container -->

        <!-- Copyright -->
        <div class="text-center p-3" style="background-color: rgba(0, 0, 0, 0.2)">
            Copyright
            <i class="far fa-copyright"></i>
            2017-2021 Prime Type Ltd
            <br>
        </div>
        <!-- Copyright -->
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4"
        crossorigin="anonymous"></script>
</body>

</html>